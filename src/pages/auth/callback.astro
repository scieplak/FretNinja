---
import Layout from "../../layouts/Layout.astro";
---

<Layout title="Confirming â€¢ FretNinja">
  <main
    id="main-content"
    class="flex min-h-screen items-center justify-center bg-slate-950 px-6 py-16 text-white"
  >
    <div class="w-full max-w-md text-center">
      <div class="rounded-2xl border border-white/10 bg-white/5 p-8 shadow-2xl shadow-slate-900/50">
        <div class="mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-emerald-400/20">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="h-6 w-6 animate-spin text-emerald-300"
            aria-hidden="true"
          >
            <path d="M21 12a9 9 0 1 1-6.219-8.56" />
          </svg>
        </div>

        <h1 class="text-xl font-semibold text-white">Processing your request...</h1>
        <p class="mt-2 text-sm text-slate-300">
          Please wait while we confirm your account. You'll be redirected shortly.
        </p>

        <noscript>
          <p class="mt-4 text-sm text-amber-200">
            JavaScript is required for this page. Please enable it and refresh.
          </p>
        </noscript>
      </div>
    </div>
  </main>
</Layout>

<script>
  const handleAuthCallback = async () => {
    const hashParams = new URLSearchParams(window.location.hash.substring(1));
    const searchParams = new URLSearchParams(window.location.search);

    const accessToken =
      hashParams.get("access_token") || searchParams.get("access_token");
    const refreshToken =
      hashParams.get("refresh_token") || searchParams.get("refresh_token");
    const type = hashParams.get("type") || searchParams.get("type");
    const error = hashParams.get("error") || searchParams.get("error");
    const errorDescription =
      hashParams.get("error_description") || searchParams.get("error_description");

    if (error) {
      console.error("Auth callback error:", error, errorDescription);
      window.location.href = `/login?error=${encodeURIComponent(errorDescription || error)}`;
      return;
    }

    if (type === "recovery" && accessToken) {
      window.location.href = `/auth/password-update?token=${accessToken}`;
      return;
    }

    if (accessToken) {
      localStorage.setItem("fn_access_token", accessToken);
      if (refreshToken) {
        localStorage.setItem("fn_refresh_token", refreshToken);
      }
      window.location.href = "/dashboard";
      return;
    }

    window.location.href = "/login";
  };

  handleAuthCallback();
</script>
