---
import Layout from "../../layouts/Layout.astro";
import { createSupabaseServerInstance } from "../../db/supabase.client";

// Handle auth callback from Supabase (email confirmation, password recovery, etc.)
const { cookies, request, url, redirect } = Astro;

// Get the auth code from URL
const code = url.searchParams.get("code");
const type = url.searchParams.get("type");
const error = url.searchParams.get("error");
const errorDescription = url.searchParams.get("error_description");

// Handle errors from Supabase
if (error) {
  console.error("Auth callback error:", error, errorDescription);
  return redirect(`/login?error=${encodeURIComponent(errorDescription || error)}`);
}

// If we have a code, exchange it for a session
if (code) {
  const supabase = createSupabaseServerInstance({
    cookies,
    headers: request.headers,
  });

  const { error: exchangeError } = await supabase.auth.exchangeCodeForSession(code);

  if (exchangeError) {
    console.error("Code exchange error:", exchangeError.message);
    return redirect(`/login?error=${encodeURIComponent("Authentication failed. Please try again.")}`);
  }

  // For password recovery, redirect to password update page
  if (type === "recovery") {
    return redirect("/auth/password-update");
  }

  // For other types (signup confirmation, magic link), redirect to dashboard
  return redirect("/dashboard");
}

// If no code, show a loading/processing message (for client-side token handling)
---

<Layout title="Confirming â€¢ FretNinja">
  <main id="main-content" class="flex min-h-screen items-center justify-center bg-slate-950 px-6 py-16 text-white">
    <div class="w-full max-w-md text-center">
      <div class="rounded-2xl border border-white/10 bg-white/5 p-8 shadow-2xl shadow-slate-900/50">
        <div class="mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-emerald-400/20">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="h-6 w-6 animate-spin text-emerald-300"
            aria-hidden="true"
          >
            <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
          </svg>
        </div>

        <h1 class="text-xl font-semibold text-white">Processing your request...</h1>
        <p class="mt-2 text-sm text-slate-300">
          Please wait while we confirm your account. You'll be redirected shortly.
        </p>

        <noscript>
          <p class="mt-4 text-sm text-amber-200">JavaScript is required for this page. Please enable it and refresh.</p>
        </noscript>
      </div>
    </div>
  </main>
</Layout>

<script>
  // Fallback client-side handling for hash-based tokens (older Supabase flows)
  const handleHashTokens = async () => {
    const hashParams = new URLSearchParams(window.location.hash.substring(1));
    const accessToken = hashParams.get("access_token");
    const refreshToken = hashParams.get("refresh_token");
    const type = hashParams.get("type");
    const error = hashParams.get("error");
    const errorDescription = hashParams.get("error_description");

    if (error) {
      window.location.href = `/login?error=${encodeURIComponent(errorDescription || error)}`;
      return;
    }

    // If we have hash tokens, we need to set up the session
    if (accessToken) {
      // For recovery, redirect to password update with token
      if (type === "recovery") {
        window.location.href = `/auth/password-update?token=${accessToken}`;
        return;
      }

      // For other flows, the session should be set via cookies by now
      // Just redirect to dashboard
      window.location.href = "/dashboard";
      return;
    }

    // No tokens found, redirect to login after a short delay
    setTimeout(() => {
      window.location.href = "/login";
    }, 2000);
  };

  // Only run client-side handling if there's a hash
  if (window.location.hash) {
    handleHashTokens();
  }
</script>
